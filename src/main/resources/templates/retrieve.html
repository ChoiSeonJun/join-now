<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- 합쳐지고 최소화된 최신 CSS -->
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

<!-- 부가적인 테마 -->
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
<title>프로젝트 게시글 자세히보기 화면</title>

<!-- 합쳐지고 최소화된 최신 자바스크립트 -->
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
<title>프로젝트 자세히보기 화면</title>

<script type="text/javascript">
	function go_list() {
		location.href = "main";
	}
</script>

<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>

<script>
	$(document).ready(function() {
		
		var author = document.getElementById('author').innerText;
		var LoggedInId = document.getElementById('LoggedInId').value;
	    
	    if (LoggedInId !== author) {
	        $('#delete').hide();
	        $('#modify-btn').hide();
	    }
	    
	    if (LoggedInId == author) {
	        $('#apply-ui-btn').hide();
	    }
		
		//delete alert
		$("#delete").on("click", function() {
   		 if (confirm('삭제하시겠습니까?') == false) {
        return false; 
   		 } else {
        alert('해당 게시글이 삭제되었습니다.');
  	  }
	});//end delete alert

		//apply alert
		$("#apply-btn").on("click", function() {
			alert("지원이 완료되었습니다.");
		});
		
		//postNo에 입력된 모든 댓글 로드
		function loadComments(postNo) {
		    var postNo = $("#postNo").val();
		    $.ajax({
		        url: 'commentList',
		        type: 'get',
		        dataType: 'json',
		        data: { postNo: postNo },
		        success: function(data) {
		            var tag = '';
		            $.each(data, function(idx, dto) {
		                tag += '<div class="comment">';
		                tag += '<span class="user" style="display: none">' + dto.writer + '</span>';
		                tag += '<span class="nickname">작성자: ' + dto.nickname + '</span>';
		                tag += '&nbsp;&nbsp;<button type="button" class="btn-custom btn-custom-success commentUpdateUI-btn">수정</button>';
		                tag += '&nbsp;<button type="button" class="btn-custom commentDelete-btn">삭제</button>';
		                tag += '<p class="timestamp">' + dto.modified_date + '</p>';
		                tag += '<p class="content commentNo" style="display: none;">' + dto.commentNo + '</p>';
		                tag += '<span class="content">' + dto.content + '</span>';
		                tag += '</div><hr>';
		            });
		            $("#commentResult").html(tag);
		            
		            //로그인한 아이디와 댓글 작성자가 다르면 댓글 수정 버튼 숨김
		            $(".comment .commentUpdateUI-btn").each(function() {
		                var writer = $(this).siblings('.user').text();
		                if (LoggedInId !== writer) {
		                    $(this).hide();
		                }
		            });
		            
		          //로그인한 아이디와 댓글 작성자가 다르면 댓글 삭제 버튼 숨김
		            $(".comment .commentDelete-btn").each(function() {
		                var writer = $(this).siblings('.user').text();
		                if (LoggedInId !== writer) {
		                    $(this).hide();
		                }
		            });
	                
		        },
		        error: function(xhr, status, error) {
		            console.error('Error: ' + error);
		            console.log(xhr.responseText);
		        }
		    });
		}//end function loadComments

	    loadComments(); //댓글 로드 function 실행
	    
	    //comment Add
	    $("#comment-btn").on("click", function(event) {
			var commentContent = document.getElementById("commentContent").value; 
			var postNo = $("#postNo").val();
		    console.log(commentContent,postNo);
		  //ajax
			$.ajax({
				url:'commentAdd',
				type:"post", //post로 요청
				dataType:"text", //text로 응답받을거야 (응답데이터 타입)
				headers:{ //요청데이터 타입
					"Content-type":"application/json" //전달할 타입(json)을 알려줌
				},
				data:JSON.stringify({content:commentContent, postNo:postNo}), //보내는 데이터는 data속성으로 보낼 수 있다.
				success: function(data,status,xhr){
					console.log(data);
					loadComments(postNo);
	                $('#commentContent').val('');
				},
				error: function(xhr, status, error) {
				    console.error("Error: " + error);
				    console.log(xhr.responseText); 
				}
			});//end ajax
			
		});//end comment-btn

	    //commentDelete
	    $(document).on("click", ".commentDelete-btn", function() {
		    var commentNo = $(this).closest(".comment").find(".content.commentNo").text();
		    $.ajax({
		        url: 'commentDelete',
		        type: 'post',
		        dataType: 'text',
		        headers: {
		            'Content-type': 'application/json',
		        },
		        data: JSON.stringify({ commentNo: commentNo }),
		        success: function(data, status, xhr) {
		            console.log(data);
		            loadComments(postNo); // Reload comments after deletion
		        },
		        error: function(xhr, status, error) {
		            console.error("Error: " + error);
		            console.log(xhr.responseText);
		        }
		    });//end ajax
		    
		});//end commentDelete
		
		//댓글 수정 입력
	    $(document).on("click", ".commentUpdateUI-btn", function() {
	        var commentNo = $(this).closest(".comment").find(".content.commentNo").text();
	        var commentdiv = $(this).closest(".comment");
	        
	        $.ajax({
	            url: 'commentListbyCno',
	            type: 'get',
	            dataType: 'json',
	            data: { commentNo: commentNo },
	            success: function(data, status, xhr) {
	                var tag = '<div class="comment">' +
	                    '<span class="user" style="display: none">' + data.writer + '</span>' +
	                    '<span class="nickname">작성자: ' + data.nickname + '</span>' +
	                    '<button type="button" class="btn-custom btn-custom-success commentUpdate-btn">수정완료</button>' +
	                    '<p class="timestamp">' + data.create_date + '</p>' +
	                    '<p style="display: none" class="content commentNo">' + data.commentNo + '</p>' +
	                    '<textarea placeholder="' + data.content + '" name="content" id="commentContent"></textarea>' +
	                    '</div>';
	                    
	                var newElement = $(tag); // string -> jQuery object
	                commentdiv.replaceWith(newElement);
	            },
	            error: function(xhr, status, error) {
	                console.error("Error: " + error);
	                console.log(xhr.responseText);
	            }
	        });
	    });
		
		//댓글 업데이트 실행
	   $(document).on("click", ".commentUpdate-btn", function() {
		   var commentNo = $(this).closest(".comment").find(".content.commentNo").text();
			var commentContent = document.getElementById("commentContent").value; 
		    console.log(commentContent,commentNo);
		  //ajax
			$.ajax({
				url:'commentUpdate',
				type:"post", //post로 요청
				dataType:"text", //text로 응답받을거야 (응답데이터 타입)
				headers:{ //요청데이터 타입
					"Content-type":"application/json" //전달할 타입(json)을 알려줌
				},
				data:JSON.stringify({content:commentContent, commentNo:commentNo}),
				success: function(data,status,xhr){
					console.log(data);
					loadComments(postNo);
	                $('#commentContent').val('');
				},
				error: function(xhr, status, error) {
				    console.error("Error: " + error);
				    console.log(xhr.responseText); 
				}
			});//end ajax
			
		});//end comment-btn


	});//end ready
</script>

<style>

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        
        .container {
        	max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 24px;
        }

        form {
            margin: 0;
            display: inline;
            height: 20px;
            float: right;
        }

        /* Comment Styles */
        .comment {
        	max-width: 1200px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background-color: #fff;
            margin: 0 auto;
            background-color: #fff;
        }

        .comment p {
            margin: 0;
            padding: 0;
        }

        .comment .user {
            font-weight: bold;
        }

        .comment .timestamp {
            font-size: 12px;
            color: #888;
        }

        /* Comment Form Styles */
        .comment-form {
            margin-top: 20px;
        }

        .comment-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        /* Button Styles */
        .btn-custom {
            display: inline-block;
            font-weight: 400;
            color: #fff;
            text-align: center;
            vertical-align: middle;
            user-select: none;
            background-color: #22577A;
            border: 1px solid #22577A;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            border-radius: 0.25rem;
            transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out,
                box-shadow 0.15s ease-in-out;
        }

        .btn-custom:hover {
            background-color: #FF9F29;
            border-color: #FF9F29;
        }

        .btn-custom-success {
            background-color: #2CA40E;
            border-color: #2CA40E;
        }

        .btn-custom-success:hover {
            background-color: #80ED99;
            border-color: #80ED99;
        }
        
    </style>

</head>
<body>
	<div class="container">
	<h1><a th:href="@{main}" style="color: #2CA40E; font-size: 24px;">JoiNow</a></h1>
		<div align="right">
			<h6>
				작성자:&nbsp;<span th:text="${postListbyNum.nickname}"></span>
			</h6>
			<h6>
				글번호:&nbsp;<span th:text="${postListbyNum.postNo}"></span>
			</h6>
			<h6>
				조회수:&nbsp;<span th:text="${postListbyNum.viewCount}"></span>
			</h6>
			<span style="display: none" id="author" th:text="${author}"></span>
			
			<input id="LoggedInId" hidden="hidden" th:value="${LoggedInId}">
		</div>
		<div class="form-group">
			<h2 class="text-center">프로젝트 모집요강</h2>
		</div>
		<hr>

		<div class="form-group">
			<h4>
				<label for="title">프로젝트명</label>
			</h4>
			<div>
				<input type="text" class="form-control" name="title"
					th:value="${postListbyNum.title}" readonly="readonly">
			</div>
		</div>
		<br>
		<div class="form-group">
			<h4>
				<label for="studyType">유형</label>
			</h4>

			<input type="text" class="form-control" name="studyType"
				th:value="${postListbyNum.studyType}" readonly="readonly">
		</div>
		<br>
		<div class="form-group">
			<h4>
				<label>지역</label>
			</h4>

			<div>
				<input type="text" class="form-control" name="onoff"
					th:value="${postListbyNum.onoff}" readonly="readonly"><br>
				<input type="text" class="form-control" name="region"
					th:value="${postListbyNum.region}" readonly="readonly">

			</div>
		</div>
		<br>
		<div class="form-group">
			<h4>
				<label for="memberRecruit">모집인원</label>
			</h4>
			<div>
				<table>
					<tr th:each="dto : ${positionList}">
						<span type="text" class="form-control" th:text="${dto.category}"></span>
						<span type="text" class="form-control"
							th:text="${dto.recruitType}"></span>
						<span type="text" class="form-control"
							th:text="${dto.memberSize != null ? dto.memberSize + '명' : 'N/A'}"></span>
						<br>
					</tr>
				</table>
			</div>
		</div>
		<br>
		<div class="form-group">
			<h4>
				<label for="content">프로젝트 설명</label>
			</h4>

			<div class="form-group">
				<input type="text" class="form-control" name="content"
					th:value="${postListbyNum.content}" readonly="readonly">
			</div>
		</div>
		<br>
		<div class="form-group">
			<h4>
				<label for="html5-date-input">프로젝트 시작일</label>
			</h4>
			<input type="date" class="form-control" name="startDate"
				th:value="${postListbyNum.startDate}" readonly="readonly">
		</div>
		<br>
		<div class="form-group">
			<h4>
				<label for="html5-date-input" class="col-sm-3 control-label">공고
					마감일</label>
			</h4>
			<div class="form-group">
				<br> <input type="date" class="form-control" name="deadline"
					th:value="${postListbyNum.deadline}" readonly="readonly">
			</div>
		</div>
		<br>
		<div class="form-group">
			<h4>
				<label for="html5-tel-input">연락처</label>
			</h4>

			<div class="form-group">
				<input type="text" class="form-control" name="contact"
					th:value="${postListbyNum.contact}" readonly="readonly">
			</div>
		</div>
		<div class="form-group">
			<input type="submit" value="목록보기" class="btn-custom"
				onclick="go_list()">

			<form action="updateUI" method="get">
				&nbsp;<input id="modify-btn" type="submit" value="수정하기" class="btn-custom btn-custom-success">
				<input id="postNo" type="hidden" th:value="${postListbyNum.postNo}"
					name="postNo">
			</form>

			<form action="delete" method="post">
				<input id="delete" type="submit" value="삭제하기" class="btn-custom">
				<input type="hidden" th:value="${postListbyNum.postNo}"
					name="postNo">
			</form>
			

			<!-- 여기서부터 지원하기 modal 구현 -->
			<!-- Button trigger modal -->
			<button type="button" class="btn-custom btn-custom-success"
				data-toggle="modal" data-target="#myModal" id="apply-ui-btn">지원하기</button>
					

			<!-- Modal -->
			<div class="container">
				<div class="modal fade" id="myModal" tabindex="-1" role="dialog"
					aria-labelledby="exampleModalScrollableTitle" aria-hidden="true">
					<div class="modal-dialog modal-dialog-scrollable" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal"
									aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
								<form action="apply" method="post">
									<h4 class="modal-title" id="exampleModalScrollableTitle">지원
										양식</h4>
									<h6 align="right">
										글번호:&nbsp;<span th:text="${postListbyNum.postNo}"></span>
									</h6>
							</div>
							<input type="hidden" th:value="${postListbyNum.postNo}"
								name="postNo">
							<div class="modal-body">
								<div class="form-group">

									<h4>
										<label for="applyType">지원분야</label>
									</h4>
									<br>
									<div>
										<select name="applyType" class="form-control">
											<option value="프론트엔드">프론트엔드</option>
											<option value="백엔드">백엔드</option>
											<option value="풀스택">풀스택</option>
										</select>
									</div>
									<br>
									<h4>
										<label for="skills">보유기술</label>
									</h4>
									<br>
									<div>
										<select name="skills" data-depth="0" class="form-control"
											onchange="selectCategory(this);">
											<option value="Java">Java</option>
											<option value="C++">C++</option>
											<option value="Kotlin">Kotlin</option>
										</select>
									</div>
									<br>
									<div>
										<h4>
											<label for="html5-tel-input">연락처</label>
										</h4>
										<br>
										<div>
											<input class="form-control" type="text" name="contact"
												id="html5-tel-input" />
										</div>
									</div>
									<br>
									<div>
										<h4>
											<label for="html5-tel-input">지원자 소개</label>
										</h4>
										<br>
										<div>
											<input class="form-control" type="text" name="content"
												id="html5-tel-input2" />
										</div>
									</div>
								</div>
							</div>
																					
							<div class="modal-footer">

								<button type="button" class="btn-custom btn-custom-success"
									data-dismiss="modal">Close</button>
								<input id="apply-btn" type="submit" value="제출" 
									class="btn-custom btn-custom-success">
							</div>
						</div>
					</div>
				</div>
						</form>
            </div>
	</div>
		</div>
			<!-- 지원하기 끝 -->
			<!-- 댓글기능 시작 -->
    <div class="comment">
    <h2>Comments</h2>
    <h4>Leave a comment</h4>
        <p id="commentResult"></p>
        <div class="comment-form">
            <textarea placeholder="Add your comment..." name="content" id="commentContent"></textarea>
            <button type="submit" class="btn-custom btn-custom-success" id="comment-btn" align="right">댓글저장</button>
        </div>
        </div>
			<!-- 댓글기능 끝 -->
</body>
</html>