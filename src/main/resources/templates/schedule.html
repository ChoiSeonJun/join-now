<!DOCTYPE html>
<html lang="ko" class="light-style customizer-hide" dir="ltr" xmlns:th="http://www.thymeleaf.org" data-theme="theme-default" data-template="vertical-menu-template-no-customizer">
<head>
<meta charset="utf-8" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

<title>일정표</title>

<!-- Favicon -->
<link rel="icon" type="image/x-icon" th:href="@{/assets/img/favicon/favicon.ico}" />

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<!-- Fullcalendar -->
<!-- <script type="application/javascript" src="../static/js/calendar.js"></script> -->
<!-- Fullcalendar 언어 설정 -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales-all.js"></script>

<script th:inline="javascript">
var calendar = null;
var event = {
		title : "",
		start : "",
		end : "",
		backgroundColor : ""
	};
	

$(document).ready(function() {
	var calendarEl = document.getElementById('calendar');
	var calendar = new FullCalendar.Calendar(calendarEl, {
		headerToolbar : {
			start : 'dayGridMonth,dayGridWeek,dayGridDay today',
			center : 'title',
			end : 'prev,next',
		},
		footerToolbar : {
			start : '',
			center : '',
			end : ''
		},
		firstDay: 1,
		titleFormat: function (date) {
		year = date.date.year;
        month = date.date.month + 1;

		return year + "년 " + month + "월";
		},

		navLinks : true, // can click day/week names to navigate views
		editable : true,
		dayMaxEvents : true, // allow "more" link when too many events
		selectable : true, // 마우스로 선택한 날짜 클릭 시 색상 변환
		locale : 'ko', // 한국어 적용
		height : 30,
		contentHeight : 'auto', // 일정개수에 맞게 달력 크기 조절
// eventAdd : function() {// 이벤트가 추가되면 발생하는 이벤트
// console.log()
// },
		
		events :  function(info, successCallback, failureCallback) {
			
			$.ajax({
                url: './select/' + [[${teamId}]], // 데이터를 제공하는 서버 엔드포인트로 수정
                type: 'GET', // GET 또는 POST로 요청을 보냄
                dataType: 'json',
                success: function(eventData) {
                    // 서버에서 받은 이벤트 데이터를 FullCalendar에 전달
                    successCallback(eventData);
                },
                error: function(error) {
                    // 에러 발생 시 처리
                    console.error('이벤트 데이터를 가져오는 중 에러 발생:', error);
                }
            });
        },
        
        eventClick: function(info) {
        	editAndDelete(info);
        },
		
		select : function(info) {
			addEvent(info);
			// eventChange: function (obj) { // 이벤트가 수정되면 발생하는 이벤트
			// allEvent = calendar.getEvents();
			// console.log(allEvent);
			// },
			// eventRemove: function (obj) { // 이벤트가 삭제되면 발생하는 이벤트
			// console.log(obj);
			// },

		},

	});

	calendar.render();
	
	function addEvent(info){
		console.log([[${scheduleId}]]);
		
		$("#backDropModal").modal("show"); // modal 나타내기

		$("#event_start_date").val(info.startStr);
		$("#event_end_date").val(info.endStr);
		
		$("#addEvent").off('click').on("click", function() {
			event.title = $("#eventContent").val().trim();
			event.start = $("#event_start_date").val();
			event.end = $("#event_end_date").val();
			event.backgroundColor = $("#event_color").val();
			
			// 일정 검증
			if (event.title == null || event.title == "") {
				alert("내용을 입력하세요.");
			} else if (new Date(event.end) - new Date(event.start) < 0) {
				alert("종료일이 시작일보다 먼저입니다.");
			} else if (event.backgroundColor == null || event.backgroundColor == "") {
				alert("색상을 선택해주세요.");
			} else {
				
				$.ajax({
		            type: 'POST',
		            url: './add/event/' + [[${teamId}]],
		            data: JSON.stringify(event),
		            contentType: 'application/json; charset=utf-8',
		            success: function(response) {
		                console.log('데이터 전송 성공. 서버 응답: ');
		            	
		            },
		            error: function(xhr, status, error) {
		                console.error('데이터 전송 실패. 에러: ' + error);
		            }
		        });

				$("#backDropModal").modal("hide");
				calendar.addEvent(event);
				$("#eventContent").val("");
				location.reload();
				
			}

		});
	}
	
	
	
	function insertModalOpen(arg){
		
	    if('<%=sessionId%>' == null){
			alert();
			location.href='login.jsp';
		}
	}
	
	function editAndDelete(info){
		$('#editDeleteModal').modal('show');
		
		// 수정 모달창 열릴 때 누른 이벤트 값 보이도록 설정
		
		$("#mEventContent").val(info.event.title);
		$("#mEvent_start_date").val(info.event.startStr);
		$("#mEvent_end_date").val(info.event.endStr);
		$("#mEvent_color").val(info.event.backgroundColor);
		
		$("#editEventButton").off('click').on("click", function() {
			const modifiedEvent = {
				id : info.event.id,
				title : $("#mEventContent").val().trim(),
				start : $("#mEvent_start_date").val(),
				end : $("#mEvent_end_date").val(),
				backgroundColor : $("#mEvent_color").val()
			};
			console.log(modifiedEvent);
			$.ajax({
				type:'POST',
				url: './update/event/' + [[${teamId}]],
				data: JSON.stringify(modifiedEvent),
				contentType: 'application/json; charset=utf-8',
				success: function(response) {	                
	                $("#editDeleteModal").modal("hide");
	                location.reload();
	            },
	            error: function(xhr, status, error) {
	                console.error('데이터 전송 실패. 에러: ' + error);
	            }
			});
		});
		
		$("#deleteEventButton").off('click').on("click", function() {
			const deleteEvent = {
					id : info.event.id,
					title : $("#mEventContent").val().trim(),
					start : $("#mEvent_start_date").val(),
					end : $("#mEvent_end_date").val(),
					backgroundColor : $("#mEvent_color").val()
				};
			$.ajax({
				type:'POST',
				url: './delete/event/' + [[${teamId}]],
				data: JSON.stringify(deleteEvent),
				contentType: 'application/json; charset=utf-8',
				success: function(response) {
	                $("#editDeleteModal").modal("hide");
	                location.reload();
	            	
	            },
	            error: function(xhr, status, error) {
	                console.error('데이터 전송 실패. 에러: ' + error);
	            }
			});
		});
		
	}
	
});


</script>

</head>

<body>

	<header th:replace="fragments/header :: header"></header>

	<!-- 캘린더 표시 -->
	<div id="calender-container">
		<div id='calendar'></div>
	</div>

	<!-- 일정 추가 모달창 -->
	<div class="modal fade" id="backDropModal" data-backdrop="static" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="backDropModalTitle">일정 추가</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<div class="row">
						<div class="col mb-3">
							<label for="eventContent" class="form-label">일정 <span class="text-danger">*</span></label>
							<input type="text" id="eventContent" class="form-control" placeholder="일정을 입력해주세요." required>
						</div>
					</div>
					<div class="row">
						<div class="col mb-0">
							<label for="event_start_date" class="form-label">시작일 <span class="text-danger">*</span></label>
							<input type="date" id="event_start_date" class="form-control" required>
						</div>
						<div class="col mb-0">
							<label for="event_end_date" class="form-label">마감일 - <small class="text-muted">선택사항</small></label>
							<input type="date" id="event_end_date" class="form-control">
						</div>
					</div>
					<div class="row">
						<div class="col mb-3">
							<label for="event_color" class="form-label">색상</label>
							<input type="color" id="event_color" class="form-control" value="#3788d8" required>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary" id="addEvent">추가</button>
				</div>
			</div>
		</div>
	</div>

	<!-- 수정 및 삭제 버튼이 있는 모달 -->
	<div class="modal fade" id="editDeleteModal" tabindex="-1" role="dialog" aria-labelledby="editDeleteModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="editDeleteModalLabel">이벤트 수정 및 삭제</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="닫기">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">

					<div class="row">
						<div class="col mb-3">
							<label for="eventContent" class="form-label">일정 <span class="text-danger">*</span></label>
							<input type="text" id="mEventContent" class="form-control" placeholder="일정을 입력해주세요." required>
						</div>
					</div>
					<div class="row">
						<div class="col mb-0">
							<label for="event_start_date" class="form-label">시작일 <span class="text-danger">*</span></label>
							<input type="date" id="mEvent_start_date" class="form-control" required>
						</div>
						<div class="col mb-0">
							<label for="event_end_date" class="form-label">마감일 - <small class="text-muted">선택사항</small></label>
							<input type="date" id="mEvent_end_date" class="form-control">
						</div>
					</div>
					<div class="row">
						<div class="col mb-3">
							<label for="event_color" class="form-label">색상</label>
							<input type="color" id="mEvent_color" class="form-control" value="#3788d8" required>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" id="editEventButton">수정</button>
					<button type="button" class="btn btn-danger" id="deleteEventButton">삭제</button>
					<button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
				</div>
			</div>
		</div>
	</div>




	<footer th:replace="fragments/footer :: footer"></footer>

	<!-- Core JS -->
	<!-- build:js assets/vendor/js/core.js -->


	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>